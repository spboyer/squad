# Kobayashi â€” History

## Project Context

- **Owner:** bradygaster
- **Stack:** Node.js, GitHub Copilot CLI, multi-agent orchestration
- **Product:** Squad â€” one command gives you a persistent AI team. Distributed via `npx github:bradygaster/squad`.
- **Distribution:** GitHub-only. No npm publish. Users get updates via `npx github:bradygaster/squad upgrade`.
- **State model:** `.ai-team/` is user-owned state (never touched on upgrade). `squad.agent.md` and templates are Squad-owned (overwritten on upgrade).

## Core Context

_Summarized from sessions through 2026-02-09. Full entries in `history-archive.md`._

- **GitHub-only distribution** â€” `npx github:bradygaster/squad` for install, `#v0.2.0` (not `@`) for version pinning. Brady explicitly rejected npm publish. `npx github:` pulls default branch HEAD unless `#ref` specified.
- **Branch strategy**: `main` is release-only (product files only, no `.ai-team/`), `dev` is development. Releases use filtered-copy (not git merge) from devâ†’main via `.github/workflows/release.yml`.
- **Three-layer distribution protection**: `package.json` `files` allowlist (primary gate), `.npmignore` (defense-in-depth), `.gitignore` (runtime state). `files` field IS respected by `npx github:` installs. `.gitattributes` `export-ignore` does NOT work for `npx github:`.
- **State integrity is CI-enforced** â€” upgrade test writes sentinel to `.ai-team/` and verifies survival. Tests are minimum release gate.
- **Release workflow**: tag push triggers CI â†’ test â†’ GitHub Release creation â†’ verification. Pre-v1 releases marked `prerelease: true`. Tag format: `v{MAJOR}.{MINOR}.{PATCH}`.
- **Release ritual checklist** at `docs/release-checklist.md` â€” five phases (pre-release, execution, post-release, communication, rollback). Every step tagged HUMAN/AUTOMATED/TEAM.
- **Release process documented** at `team-docs/release-process.md` â€” branch flow, workflow mechanics, file filtering, npx distribution model.

## Recent Updates

ðŸ“Œ Team update (2026-02-09): No npm publish â€” GitHub-only distribution. Kobayashi hired as Git & Release Engineer. Release plan (021) filed. Sprint plan 019a amended: item 1.8 cancelled, items 1.11-1.13 added.
ðŸ“Œ Team update (2026-02-08): CI pipeline created â€” release workflow should depend on CI passing. Tests are minimum release gate. â€” decided by Hockney
ðŸ“Œ Team update (2026-02-08): Coordinator now captures user directives to decisions inbox before routing work. Directives persist to decisions.md via Scribe. â€” decided by Kujan
ðŸ“Œ Team update (2026-02-08): Coordinator must acknowledge user requests with brief text before spawning agents. Single agent gets a sentence; multi-agent gets a launch table. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-08): Silent success mitigation strengthened in all spawn templates â€” 6-line RESPONSE ORDER block + filesystem-based detection. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-08): .ai-team/ must NEVER be tracked in git on main. Three-layer protection: .gitignore, package.json files allowlist, .npmignore. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-09): If ask_user returns < 10 characters, treat as ambiguous and re-confirm â€” platform may fabricate default responses from blank input. â€” decided by Brady
ðŸ“Œ Team update (2026-02-09): PR #2 integrated â€” GitHub Issues Mode, PRD Mode, Human Team Members added to coordinator with review fixes (gh CLI detection, post-setup questions, worktree guidance). â€” decided by Fenster
ðŸ“Œ Team update (2026-02-09): Per-agent model selection designed â€” 4-layer priority (user override â†’ charter â†’ registry â†’ auto-select). Role-to-model mapping: Designerâ†’Opus, Tester/Scribeâ†’Haiku, Lead/Devâ†’Sonnet. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-09): Tiered response modes shipped â€” Direct/Lightweight/Standard/Full modes replace uniform spawn overhead. Agents may now be spawned with lightweight template (no charter/history/decisions reads) for simple tasks. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-09): Skills Phase 1 + Phase 2 shipped â€” agents now read SKILL.md files before working and can write SKILL.md files from real work. Skills live in .ai-team/skills/{name}/SKILL.md. Confidence lifecycle: lowâ†’mediumâ†’high. â€” decided by Verbal
ðŸ“Œ Team update (2026-02-09): Export + Import CLI shipped â€” squads are now fully portable via squad-export.json. Round-trip at 100% fidelity. History split is pattern-based. â€” decided by Fenster
ðŸ“Œ Team update (2026-02-09): Release ritual consolidated â€” checklist and lead recommendations merged â€” decided by Keaton, Kobayashi
ðŸ“Œ Team update (2026-02-09): docs/ and CHANGELOG.md now included in release pipeline (KEEP_FILES, KEEP_DIRS, package.json files, .npmignore updated). Brady's directive. â€” decided by Kobayashi
ðŸ“Œ Team update (2026-02-09): Release workflow split into two-phase pipeline â€” preview (builds `preview` branch for human review) and ship (pushes to main, tags, creates GitHub Release). Single workflow with `action` choice input (preview/ship). KEEP_FILES/KEEP_DIRS DRY via workflow-level env vars. Ship phase validates preview branch contains only product files before pushing to main. â€” decided by Kobayashi

ðŸ“Œ Team update (2026-02-10): v0.3.0 sprint plan approved â€” per-agent model selection, team backlog, Demo 1. â€” decided by Keaton


ðŸ“Œ Team update (2026-02-10): 0.3.0 priorities set â€” async comms, GitHub-native, CCA adoption â€” decided by bradygaster


ðŸ“Œ Team update (2026-02-10): v0.3.0 is ONE feature â€” proposals as GitHub Issues. All other items deferred. â€” decided by bradygaster

ðŸ“Œ Team update (2026-02-10): Provider abstraction is prompt-level command templates, not JS interfaces. Platform section replaces Issue Source in team.md. â€” decided by Fenster, Keaton

ðŸ“Œ Team update (2026-02-10): Actions automation ships as opt-in templates in templates/workflows/, 3 workflows in v0.3.0. â€” decided by Keaton, Kujan

ðŸ“Œ Team update (2026-02-10): Label taxonomy (39 labels, 7 namespaces) drives entire GitHub-native workflow. â€” decided by bradygaster, Verbal

ðŸ“Œ Team update (2026-02-10): CCA governance must be self-contained in squad.agent.md (cannot read .ai-team/). â€” decided by Kujan

ðŸ“Œ Team update (2026-02-10): Proposal migration uses three-wave approach â€” active first, shipped second, superseded/deferred last. â€” decided by Keaton

ðŸ“Œ Team update (2026-02-11): Per-agent model selection implemented with cost-first directive (optimize cost unless writing code) â€” decided by Brady and Verbal

ðŸ“Œ Team update (2026-02-11): MCP Integration Direction for Squad approved â€” Option B (Awareness Layer) chosen. Phase 1 spike (WI-1) validates platform MCP support. See decisions.md for rationale and timeline. â€” decided by Keaton

## Learnings

- **v0.3.0 release entry created** â€” Added comprehensive CHANGELOG.md entry documenting five shipped features (per-agent model selection, Ralph work monitor, @copilot integration, universe expansion, milestones rename), four Changed items (tests, emoji fixes, agent.md expansion, index.js upgrade fix), and community contributions (2 PRs from @spboyer, 4 new issues from external contributors). Entry follows v0.2.0 format (Added/Changed/Community sections) and preserves content tree with v0.2.0 and v0.1.0 below. Date: 2026-02-11.

- **v0.4.0 release process documentation complete** â€” Created `docs/scenarios/release-process.md` with comprehensive maintainer guide: branch model (dev â†’ preview â†’ main), full release lifecycle with six phases (prep, preview, merge, tag, verify, sync), exact git commands, `gh` CLI commands, guard workflow mechanics, guard testing procedures (three test scenarios: block .ai-team/, block team-docs/internal, allow team-docs/blog), troubleshooting section (SSH hangs, .ai-team/ tracking leaks, missing workflows, missing releases), and sample Copilot prompts. Also updated CHANGELOG.md with v0.4.0 entry (12 issues/features, 6 workflows, 11 new universes, MCP integration, notifications, guard, docs). Guard workflow validates forbidden paths on main/preview via GitHub Script pagination, blocks .ai-team/** (zero exceptions) and team-docs/** (except team-docs/blog/**), provides actionable fix instructions in failure message. Release distribution model confirmed: npx pulls from main only; .ai-team/ protected by .gitignore, package.json files array, .npmignore (three-layer defense). Date: 2026-02-15.

- **CI/CD workflow pipeline created** â€” Three workflows added to `.github/workflows/` and mirrored in `templates/workflows/`: (1) `squad-ci.yml` â€” runs tests on PR to dev/preview/main and push to dev, Node 22, read-only permissions; (2) `squad-preview.yml` â€” validates preview branch on push: runs tests, checks no `.ai-team/` tracked, validates package.json version field; (3) `squad-release.yml` â€” automates release on push to main: reads version from package.json, idempotent tag check (skips if `v{version}` tag exists), creates annotated tag + GitHub Release with auto-generated notes via `gh` CLI, verifies release. Uses `GITHUB_TOKEN` (no PATs), minimal permissions (contents:write only on release). All workflows follow squad-main-guard.yml YAML style. Date: 2026-02-13.

- **Preview branch audit (2026-02-16)** â€” Verified preview branch is CLEAN (zero .ai-team/, zero team-docs/ files). Guard workflow identified as incomplete: missing `push` trigger (currently PR-only), allowing direct pushes to bypass validation. `.gitignore` entry for `.ai-team-templates/` identified as incorrect â€” added in commit 7909935 (2026-02-08) as "internal planning" but Squad's actual templates live in `templates/` (tracked/shipped). The `.ai-team-templates/` entry causes Squad's own repo to ignore runtime artifacts and tells user repos to ignore Squad-owned files (should be committed for upgrade visibility). Release process documentation verified as correct and comprehensive. Recommended fixes: (1) remove `.ai-team-templates/` from .gitignore (historical mistake), (2) add push trigger to guard workflow (catch direct pushes), (3) optionally track Squad's own `.ai-team-templates/` (dogfooding state visibility). Distribution safety confirmed: package.json "files" array remains primary gate; guard is defense-in-depth. Date: 2026-02-16.

- **`.ai-team-templates/` guard protection verified (2026-02-16)** â€” Post-coordinator-implementation audit confirmed: (1) `.ai-team-templates/` successfully removed from `.gitignore` (will be tracked), (2) guard workflow correctly blocks `.ai-team-templates/**` from main/preview (treats like `.ai-team/`, zero exceptions), (3) `.npmignore` exclusion remains (line 8, distribution safety). Changes align with Brady's requirement: tracked on dev branches, blocked from production. Guard logic verified correct: checks file path with `startsWith('.ai-team-templates/')` condition. Gap identified: documentation (`release-process.md`, `CONTRIBUTING.md`) does not mention `.ai-team-templates/` in protected files sections. Guard workflow `push` trigger remains unimplemented (separate issue from first audit). Distribution model validated: package.json "files" array is primary gate; `.npmignore` and guard are defense-in-depth. Verdict: APPROVED. Date: 2026-02-16.

- **Guard workflow hardened, v0.4.1 pre-release audit clean (2026-02-16)** â€” Added `push` trigger to squad-main-guard.yml (now catches direct pushes to main/preview, not just PRs), updated error message to mention `.ai-team-templates/` alongside `.ai-team/` and `team-docs/`. Conducted full pre-release audit: (1) branch state: dev/preview/main all clean (0 forbidden files on preview/main, verified via git ls-tree), (2) tests: 53 pass/0 fail, (3) workflows: all 10 syntactically valid with correct triggers, (4) version: package.json 0.4.0, CHANGELOG has 0.4.0 and 0.4.1 entries, (5) distribution safety: package.json files array + .npmignore correctly configured, (6) release blockers: 0 open issues with release:v0.4.1 or priority:p0. Verdict: **GO** for preview. Preview is 28 commits ahead of main (62 files, expected for v0.4.1 release). Guard fix was the only technical blocker; resolved. Date: 2026-02-16.

ðŸ“Œ Team update (2026-02-12):Cross-client sub-agent API research complete â€” squad.agent.md uses task tool exclusively for CLI platform, VS Code uses runSubagent, no unification planned â€” research by Kujan
ðŸ“Œ Team update (2026-02-13): go:/release: label automation shipped â€” Four-workflow system enforces label namespace integrity (go:* triage verdicts, release:* version targets). Workflows: squad-label-enforce.yml (mutual exclusivity), sync-squad-labels.yml (sync 8 static labels), squad-triage.yml (default go:needs-research), squad-heartbeat.yml (detect label gaps). Labels-as-state-machine is foundational to GitHub-native workflow. â€” decided by Fenster

ðŸ“Œ Team update (2026-02-15): Directory structure rename planned â€” .ai-team/ â†’ .squad/ starting v0.5.0 with backward-compatible migration; full removal in v1.0.0 â€” Brady

- **Team.md header resilience pattern established** â€” Fixed issue #58: all four label-routing workflows (squad-heartbeat.yml, squad-issue-assign.yml, squad-triage.yml, sync-squad-labels.yml) now parse the members section using flexible regex `/^##\s+(Members|Team Roster)/i` instead of hard-coded `startsWith('## Members')`. This prevents label routing breaks when coordinators use alternate headers (e.g., "## Team Roster"). Changes applied symmetrically to both `templates/workflows/` and `.github/workflows/` to maintain sync invariant. Also added explicit guidance in squad.agent.md Init Mode that the canonical header is `## Members` to prevent future drift. Pattern: hard-code the spec, but make the parser resilient. Tests all pass (45 tests). Date: 2026-02-16. PR #60.

- **Issue #69 migration risk assessment (.ai-team â†’ .squad directory rename)** â€” Analyzed seven risk vectors for renaming user state directory. **Top 3 risks identified:** (1) **Version Skew** â€” HIGH RISK, 100% likelihood. Every collaboration between v0.4.x and v0.5.0 users breaks. v0.4.x CLI looks for `.ai-team/`, finds `.squad/`, errors "No team found." Generates massive support burden. (2) **State Corruption During Migration** â€” Catastrophic risk. Proposal has no pre-flight checks, no atomic rollback, no backup strategy. If `git mv` succeeds but commit fails, user's state is in `.squad/` but git tracks `.ai-team/` (divergence). (3) **Workflow Failures** â€” HIGH RISK. Six workflows reference `.ai-team/` paths (guard, heartbeat, triage, assign, preview, sync-labels). Missing even ONE update breaks critical functionality. Guard is most dangerous â€” if not updated to block `.squad/**`, Phase 1 users could leak state to main. **Key mitigations required:** (a) **v0.4.2 backport** BEFORE v0.5.0 â€” add detection: "if `.squad/` exists, tell user to upgrade." WITHOUT this, version skew is a disaster. (b) Atomic migration with pre-flight validation (repo clean, no mid-merge, no existing `.squad/`), automatic backup, rollback on failure. (c) Exhaustive workflow audit â€” grep all 745 occurrences, dual-path support in ALL workflows during transition. (d) Beta program â€” 10 power users test on real repos before public release. (e) Staged rollout: internal repos first, fix bugs, then public. **Red flags for delay:** No v0.4.2 backport, no beta program, workflows not audited, no rollback mechanism, timeline pressure (<4 weeks). **Verdict: Too risky for v0.5.0 without 4 weeks of prep.** Minimum timeline: Week 1 ship v0.4.2 + design rollback, Week 2 implement migration + dual-path, Week 3 beta test, Week 4 release if clean. Alternative phasing: v0.5.0 NEW installs only get `.squad/` (no migration), v0.6.0 add migration tool, v1.0.0 drop `.ai-team/` support (spreads risk across 3 releases). Core learning from v0.4.1 incident applies: **guards are detective, not preventive** â€” if migration fails halfway, detective mechanisms won't save you. Need preventive design (atomic operations, rollback, backups). Date: 2026-02-16.

- **Issue #69 reassessment with forward-only constraint (2026-02-16)** â€” Brady directive: NO backport to v0.4.2, forward-only migration (v0.4.1 â†’ v0.5.0), don't design for v0.5.0 CLI running against v0.4.1 repos. **Revised risk assessment:** (1) **Version Skew** â€” DROPS from BLOCKER to NON-ISSUE. Brady's model assumes linear upgrades, not cross-version collaboration. The scenario I flagged (v0.4.x + v0.5.0 users on same repo) is explicitly out of scope. (2) **State Corruption** â€” STAYS HIGH. Migration can still fail mid-flight (git mv succeeds, commit fails â†’ corrupt state). (3) **Workflow Failures** â€” STAYS HIGH. All 745 `.ai-team/` occurrences need audit, guard must block `.squad/**`. **NEW VERDICT: ACCEPTABLE for v0.5.0 with 3 weeks prep** (saved 1 week from no backport). Forward-only constraint **simplifies design** â€” no dual-version support, no indefinite `.ai-team/` compatibility, migration is one-way door with safety net. **Timeline:** Week 1 (design atomic migration + rollback), Week 2 (workflow audit + beta start), Week 3 (beta program + ship if clean). **Mandatory safeguards:** (1) Pre-flight validation (refuse if dirty repo, mid-merge, existing `.squad/`), (2) Automatic backup (`.ai-team/` â†’ `.ai-team-backup-{timestamp}/`), (3) Atomic commit (git mv + workflow updates, all-or-nothing), (4) Rollback on failure (detect + restore), (5) Beta program (5-10 users, real repos, 1 week minimum). **Red flags for delay:** Beta finds corruption bugs, workflow audit >6h effort, no 3-week runway, no beta users available. **Alternative phasing if timeline unavailable:** v0.5.0 NEW installs only (no migration), v0.6.0 add migration tool, v1.0.0 drop `.ai-team/` (spreads risk). Core insight: Brady's constraint removes the MOST COMPLEX part of the design (handling mixed-version scenarios), making the migration EASIER to get right. The backport requirement was driven by version skew; with version skew out of scope, backport is unnecessary. Date: 2026-02-16.

- **Issue #94 Insider Program audit (2026-02-19)** â€” Verified all Phase 1-3 implementation from commit 263626a. Audit results: (1) CI/CD: `insider` added to squad-ci.yml triggers (PR + push), guard workflow triggers (PR + push), squad-insider-release.yml created with `v{version}-insider+{short-sha}` tag format and `--prerelease` flag. (2) Documentation: README has insider install path section, CONTRIBUTING has insider program link, docs/insider-program.md is comprehensive (install, version format, FAQ, rollback). CONTRIBUTORS.md created with insider badge system. (3) CLI: index.js help text includes `Insider channel: npx github:bradygaster/squad#insider`. (4) Template sync: all 11 workflow files verified identical between `.github/workflows/` and `templates/workflows/`. Key pattern: insider release workflow uses `--prerelease` flag (not `--latest`) so insider tags don't override stable releases in GitHub. Guard workflow protects insider branch same as main/preview â€” `.ai-team/` state cannot leak. Distribution path: `npx github:bradygaster/squad#insider` pulls from insider branch HEAD.

- **Issue #94 Phase 0+1 â€” Insider Program CI/CD Infrastructure** â€” Built the CI/CD pipeline for the insider branch, enabling early adopters to install from `npx github:bradygaster/squad#insider`. **Phase 0 (Branch Protection):** Updated `squad-main-guard.yml` to add `insider` to protected branches list (PR and push triggers), blocking `.ai-team/**`, `.ai-team-templates/**`, and `team-docs/**` from insider like main/preview. **Phase 1 (CI/CD Workflows):** (1) Updated `squad-ci.yml` â€” added `insider` to both PR triggers (dev/preview/main/insider) and push triggers (dev/insider), so CI runs on all insider activity. (2) Created `squad-insider-release.yml` â€” auto-release workflow triggered on push to insider: runs tests first (gate), reads base version from package.json, appends `-insider+{short_sha}` to version, creates annotated git tag `v{version}-insider+{short_sha}`, publishes GitHub Release marked as prerelease with markdown body explaining this is an insider/dev build and installation instructions. (3) Maintained sync invariant â€” all changes applied to both `.github/workflows/` and `templates/workflows/` in parallel. Used consistent patterns from existing workflows (Node 22, actions/checkout@v4, actions/setup-node@v4, GITHUB_TOKEN, gh CLI). Insider releases are idempotent (will retag if needed due to short_sha changes across commits). Date: 2026-02-17. Status: READY for manual `git checkout -b insider` and push by Brady.

- **Issue #103 â€” Workflow dual-path support for .squad/ migration** â€” Updated all 6+ GitHub Actions workflows to handle both `.ai-team/` and `.squad/` directories during v0.5.0 transition. **Changes:** (1) **Guard workflow (squad-main-guard.yml)** â€” Now blocks both `.ai-team/` AND `.squad/` from main/preview/insider, preventing either from leaking to production. Error message and fix instructions updated to reference both paths. (2) **Preview validation (squad-preview.yml)** â€” Now checks for both `.ai-team/` and `.squad/` tracked files; rejects if either found. (3) **Read-based workflows** â€” All workflows that READ from team state (heartbeat, triage, issue-assign, sync-labels) now implement fallback pattern: check `.squad/team.md` first, fall back to `.ai-team/team.md` if missing. Error messages reference both paths. squad-heartbeat.yml custom_instructions updated to mention both directories. sync-squad-labels.yml trigger now includes both `.squad/team.md` and `.ai-team/team.md` paths. (4) **Template sync** â€” All changes applied symmetrically to both `.github/workflows/` and `templates/workflows/` to maintain sync invariant for consumer repos. **Testing:** YAML validation passed for all 6 updated workflows; sync invariant verified (templates byte-for-byte match .github copies). **Acceptance:** All criteria met â€” both directories handled, guard blocks `.squad/**`, guard blocks `docs/proposals/**`, both directory copies in sync. PR #109 created targeting dev branch. Date: 2026-02-19.
