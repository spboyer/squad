name: Release

# Two-phase release pipeline:
#   Phase 1 ("preview") — Tests, validates, builds filtered product files, pushes to `preview` branch.
#   Phase 2 ("ship")    — Pushes preview content to main, tags, creates GitHub Release, verifies.
#
# Brady eyeballs the preview branch between phases. Nothing ships until he says go.

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Release phase'
        required: true
        type: choice
        options:
          - preview
          - ship
      version:
        description: 'Release version (e.g. 0.2.0) — must match package.json'
        required: true
        type: string

permissions:
  contents: write

# ── Shared product-file allowlist (used by both preview and ship) ──
# Defined as env vars so both jobs reference the same list.
env:
  # Space-separated; parsed into bash arrays in steps that need them
  KEEP_FILES: "index.js package.json README.md LICENSE CHANGELOG.md .gitignore .npmignore .gitattributes .github/agents/squad.agent.md"
  KEEP_DIRS: "templates docs"

jobs:
  # ════════════════════════════════════════════════════════════════
  # Phase 1: Preview — test, validate, build preview branch
  # ════════════════════════════════════════════════════════════════

  # ── Gate: tests must pass before anything ships ──
  test:
    name: Test on dev
    if: github.event.inputs.action == 'preview'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Run tests
        run: npm test

  # ── Build preview branch ──
  preview:
    name: Build preview branch
    if: github.event.inputs.action == 'preview'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Validate version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: requested=$VERSION, package.json=$PKG_VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "✓ Version validated: $VERSION"

      - name: Build product file staging area
        run: |
          read -ra KEEP_FILES_ARR <<< "$KEEP_FILES"
          read -ra KEEP_DIRS_ARR <<< "$KEEP_DIRS"

          STAGING=$(mktemp -d)

          for f in "${KEEP_FILES_ARR[@]}"; do
            if [ -f "$f" ]; then
              mkdir -p "$STAGING/$(dirname "$f")"
              cp "$f" "$STAGING/$f"
            fi
          done

          for d in "${KEEP_DIRS_ARR[@]}"; do
            if [ -d "$d" ]; then
              cp -r "$d" "$STAGING/$d"
            fi
          done

          echo "── Staged product files ──"
          find "$STAGING" -type f | sort
          echo "STAGING=$STAGING" >> $GITHUB_ENV

      - name: Push to preview branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to preview (create if it doesn't exist)
          git checkout preview 2>/dev/null || git checkout --orphan preview

          # Remove everything in the working tree
          git rm -rf . > /dev/null 2>&1 || true
          rm -rf *

          # Copy staged product files into working tree
          cp -r "$STAGING"/. .

          # Stage all product files
          git add -A

          # Commit (always — even if content matches, the preview commit message is informational)
          if git diff --cached --quiet; then
            echo "No changes vs. current preview — content is identical"
          else
            git commit -m "preview: v${{ steps.version.outputs.version }}"
          fi

          git push origin preview --force
          echo "✓ Preview branch pushed — ready for review"
          echo ""
          echo "  git checkout preview   # to inspect locally"
          echo "  Run 'ship' action when ready to release"

  # ════════════════════════════════════════════════════════════════
  # Phase 2: Ship — push preview → main, tag, GitHub Release
  # ════════════════════════════════════════════════════════════════

  ship:
    name: Ship preview to main
    if: github.event.inputs.action == 'ship'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: preview

      - name: Validate version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: requested=$VERSION, package.json=$PKG_VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "✓ Version validated: $VERSION"

      - name: Validate preview contains only product files
        run: |
          read -ra KEEP_FILES_ARR <<< "$KEEP_FILES"
          read -ra KEEP_DIRS_ARR <<< "$KEEP_DIRS"

          echo "── Checking preview branch content ──"
          FAIL=0
          while IFS= read -r file; do
            ALLOWED=0
            for f in "${KEEP_FILES_ARR[@]}"; do
              if [ "$file" = "$f" ]; then ALLOWED=1; break; fi
            done
            if [ "$ALLOWED" = "0" ]; then
              for d in "${KEEP_DIRS_ARR[@]}"; do
                if [[ "$file" == "$d/"* ]]; then ALLOWED=1; break; fi
              done
            fi
            if [ "$ALLOWED" = "0" ]; then
              echo "::error::Unexpected file on preview branch: $file"
              FAIL=1
            fi
          done < <(git ls-files)

          if [ "$FAIL" = "1" ]; then
            echo "::error::Preview branch contains non-product files. Aborting."
            exit 1
          fi
          echo "✓ Preview branch contains only product files"

      - name: Push to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to main (create if it doesn't exist)
          git checkout main 2>/dev/null || git checkout --orphan main

          # Remove everything in the working tree
          git rm -rf . > /dev/null 2>&1 || true
          rm -rf *

          # Copy preview content into working tree
          git checkout preview -- .

          # Stage all product files
          git add -A

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit — main is already up to date"
          else
            git commit -m "release: v${{ steps.version.outputs.version }}"
          fi

          # Tag the release commit on main
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"

      - name: Push main and tag
        run: |
          git push origin main
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV=$(git tag --sort=-creatordate | grep '^v' | sed -n '2p')
          echo "prev_tag=${PREV:-}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          PREV_TAG: ${{ steps.prev_tag.outputs.prev_tag }}
        with:
          script: |
            const tag = process.env.TAG;
            const version = process.env.VERSION;
            const prevTag = process.env.PREV_TAG;

            const body = [
              `## Install`,
              '```bash',
              `npx github:bradygaster/squad`,
              '```',
              '',
              `## Upgrade`,
              '```bash',
              `npx github:bradygaster/squad upgrade`,
              '```',
              '',
              `## Pin this version`,
              '```bash',
              `npx github:bradygaster/squad#${tag}`,
              '```',
            ].join('\n');

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Squad ${tag}`,
              body: body,
              draft: false,
              prerelease: version.startsWith('0.'),
              generate_release_notes: true,
            });

  # ── Verify: confirm npx resolution works ──
  verify:
    name: Verify release
    needs: ship
    runs-on: ubuntu-latest
    steps:
      - name: Wait for GitHub propagation
        run: sleep 15

      - name: Verify npx resolves
        run: |
          mkdir -p /tmp/verify-release && cd /tmp/verify-release
          npx -y github:bradygaster/squad --version
          echo "✓ Release verified"
